<script>
const DATA_URL = 'geelong_r1.json';   // <-- point to the JSON above

// ---- AI-Bet v3.7-WET core --------------------------------------------
// Weights tuned for wet tracks (Soft 6 today)
const WEIGHTS = {
  rating: 0.45,     // class/ability anchor
  wet:    0.35,     // Soft+Heavy bias (bigger today)
  dist:   0.20      // 2400 m suitability
};

//  (wins + 0.5*places) / starts  -> smooths tiny samples
function perfIndex({starts, wins, places}) {
  if (!starts || starts <= 0) return 0;
  return (wins + 0.5 * (places || 0)) / starts; // 0..1
}

function zNorm(values) {
  const n = values.length;
  const mean = values.reduce((a,b)=>a+b,0)/n;
  const sd = Math.sqrt(values.map(v=>(v-mean)**2).reduce((a,b)=>a+b,0)/n) || 1e-9;
  return values.map(v => (v-mean)/sd);
}

async function runWetSim() {
  const res = await fetch(DATA_URL);
  const data = await res.json();
  const R = data.runners.map(r => {
    // Base class signal (normalized rating)
    const baseRating = r.rating || 0;

    // Wet signal – Soft gets full weight, Heavy gets 0.6 (Soft 6 meeting)
    const softI  = perfIndex(r.soft);
    const heavyI = 0.6 * perfIndex(r.heavy);
    const wetI   = 0.7 * softI + 0.3 * heavyI; // blend & slightly favor Soft

    // Distance suitability (2400m)
    const distI  = perfIndex(r.distance);

    return {
      ...r,
      _raw: { baseRating, wetI, distI }
    };
  });

  // Normalize each component across field
  const zRating = zNorm(R.map(x => x._raw.baseRating));
  const zWet    = zNorm(R.map(x => x._raw.wetI));
  const zDist   = zNorm(R.map(x => x._raw.distI));

  // AI Score = weighted sum of z-scores -> min-max to 0..100 for display
  const scores = R.map((_, i) => (
    WEIGHTS.rating * zRating[i] +
    WEIGHTS.wet    * zWet[i] +
    WEIGHTS.dist   * zDist[i]
  ));
  const minS = Math.min(...scores), maxS = Math.max(...scores);
  const scaled = scores.map(s => 100*(s - minS)/(maxS - minS || 1));

  // Convert to probabilities with softmax (temperature 1.35 to reduce overconfidence)
  const T = 1.35;
  const exps = scaled.map(s => Math.exp(s/T));
  const Z = exps.reduce((a,b)=>a+b,0);
  const probs = exps.map(e => e/Z);

  // Edge vs market (simple: model prob – implied from odds)
  function impliedP(odds){ return odds>1 ? 1/odds : 0; }
  const out = R.map((r,i)=>({
    number: r.number,
    name: r.name,
    rating: r.rating,
    odds_win: r.odds_win,
    model_prob: probs[i],
    edge: probs[i] - impliedP(r.odds_win),
    softI: r._raw.wetI,
    distI: r._raw.distI
  }))
  .sort((a,b)=> b.model_prob - a.model_prob);

  // ---- Render (very light; adapt to your page styles) ----------------
  const $root = document.getElementById('sim-output') || document.body;
  const hdr = document.createElement('div');
  hdr.innerHTML = `
    <h2>AI-Bet v3.7 — Wet Track Simulation</h2>
    <p><strong>${data.meeting}</strong> • ${data.race} • <strong>${data.track}</strong></p>
  `;
  $root.appendChild(hdr);

  const top4 = out.slice(0,4).map((r,idx)=>
    `${idx+1}. #${r.number} ${r.name} (${(r.model_prob*100).toFixed(1)}%)`
  ).join('<br>');
  const blk = document.createElement('div');
  blk.style.margin = '12px 0 18px';
  blk.innerHTML = `<h3>Predicted Order (Top 4)</h3><div style="padding:12px;border:1px solid #2fe9a3;border-radius:8px">${top4}</div>`;
  $root.appendChild(blk);

  const table = document.createElement('table');
  table.style.width='100%';
  table.style.borderCollapse='collapse';
  table.innerHTML = `
    <thead><tr>
      <th style="text-align:left">#</th>
      <th style="text-align:left">Runner</th>
      <th>Rating</th>
      <th>Odds</th>
      <th>Model %</th>
      <th>Edge</th>
      <th>Wet idx</th>
      <th>2400m idx</th>
    </tr></thead>
    <tbody>
      ${out.map(r=>`
        <tr>
          <td>#${r.number}</td>
          <td>${r.name}</td>
          <td>${r.rating}</td>
          <td>${r.odds_win.toFixed(2)}</td>
          <td>${(r.model_prob*100).toFixed(1)}</td>
          <td>${(r.edge*100).toFixed(1)}%</td>
          <td>${r.softI.toFixed(2)}</td>
          <td>${r.distI.toFixed(2)}</td>
        </tr>
      `).join('')}
    </tbody>`;
  Array.from(table.querySelectorAll('td,th')).forEach(c=>{
    c.style.padding='6px 8px';
    c.style.borderBottom='1px solid rgba(255,255,255,0.08)';
  });
  $root.appendChild(table);

  console.log('v3.7-WET raw model output:', out);
}

document.addEventListener('DOMContentLoaded', runWetSim);
</script>
