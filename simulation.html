 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI-Bet v3.7 — Summation (Edge Finder)</title>
  <style>
    :root {
      --bg: #0b0d10; --panel:#12161c; --ink:#e8f0ff; --muted:#9bb0c9; --accent:#00e1ae;
      --bad:#ff6b6b; --good:#61d095; --warn:#ffd166; --line:#1f2a38;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    nav{
      background:#0e131a; border-bottom:1px solid var(--line);
      padding:14px 18px; display:flex; gap:18px; justify-content:center; align-items:center;
    }
    nav a{color:#fff; text-decoration:none; font-weight:700}
    .wrap{max-width:1100px; margin:26px auto; padding:0 16px}
    h1{font-size:24px; margin:0 0 4px}
    .meta{
      background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:14px 16px; margin:10px 0 20px;
      display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:10px; color:var(--muted)
    }
    .meta b{color:var(--ink)}
    table{width:100%; border-collapse:collapse; background:var(--panel); border-radius:10px; overflow:hidden}
    thead{background:#0f141b}
    th, td{padding:10px 12px; border-bottom:1px solid var(--line); text-align:right; white-space:nowrap}
    th:nth-child(2), td:nth-child(2){text-align:left}
    th:first-child, td:first-child{text-align:center}
    tfoot td{border-top:2px solid var(--line); font-weight:700}
    .pill{display:inline-block; padding:2px 7px; border-radius:999px; background:#0e1922; border:1px solid var(--line); font-size:12px}
    .edge-good{color:var(--good); font-weight:700}
    .edge-bad{color:var(--bad); font-weight:700}
    .note{color:var(--muted); font-size:13px; margin-top:10px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    .top4{
      background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:14px 16px
    }
    .tag{border:1px solid var(--line); padding:2px 6px; border-radius:6px; color:var(--muted); font-size:12px}
    .badge{font-weight:700; color:#111; background:var(--accent); border-radius:6px; padding:3px 8px}
    .small{font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
  <!-- Simple site nav (matches your other pages) -->
  <nav>
    <a href="index.html">Home</a>
    <a href="summary.html">Summary</a>
    <a href="insights.html">Insights</a>
    <a href="graph.html">Graph</a>
    <a href="summation.html" style="border-bottom:2px solid var(--accent)">Summation</a>
  </nav>

  <div class="wrap">
    <h1>AI-Bet v3.7 · Summation / Edge Finder</h1>
    <div id="meta" class="meta"></div>

    <div class="grid">
      <div class="top4">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <h2 style="margin:0;font-size:18px">Predicted Order (Top 4)</h2>
          <span class="tag">Model v3.7</span>
        </div>
        <ol id="top4" style="margin:10px 0 0 18px; padding:0 0 0 6px"></ol>
        <div class="note">Edge = Model probability − Market probability. Positive edge means overlay vs the market.</div>
      </div>

      <div>
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>Runner</th>
              <th class="small">Odds</th>
              <th class="small">Rating</th>
              <th class="small">Wt</th>
              <th class="small">TrackFit</th>
              <th class="small">DistFit</th>
              <th class="small">Score</th>
              <th class="small">Model%</th>
              <th class="small">Market%</th>
              <th>Edge%</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="11" class="small muted">
              <span class="mono">TrackFit</span> uses Good/Soft/Heavy records against today’s condition. 
              <span class="mono">DistFit</span> scores proximity to preferred distance. 
              Weight is normalized to 56.5kg. Softmax turns scores into model probabilities.
            </td></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <p class="note">
      Data below is inline for the demo. You can replace with any past race. Only the fields used by the model are required.
    </p>
  </div>

<script>
/*
  ===========
  INPUT DATA
  ===========
  Replace this object with any race. (Screenshots you sent matched Caulfield R2 style.)
*/
const RACE = {
  meeting: "Caulfield",
  race_name: "R2 Sportsbet Classic (G3)",
  distance_m: 2000,
  track_condition: "Good 4",
  rail: "Out 3m Entire Circuit",
  date: "Sat 18 Oct 2025 12:50 PM",
  // Runners. If you don’t know a field, omit it and the model will neutral-weight it.
  horses: [
    { no: 2, name: "Miewa",            rating: 74,  weight: 57.0, odds: 4.20, good:{w:4,p:2,s:7}, soft:{w:2,p:0,s:2}, heavy:{w:0,p:0,s:0}, best_dist: 1800 },
    { no: 3, name: "Autumn Mystery",   rating: 68,  weight: 57.0, odds: 4.80, good:{w:5,p:3,s:10},soft:{w:2,p:1,s:3}, heavy:{w:1,p:0,s:1}, best_dist: 2000 },
    { no: 5, name: "Engine Of War",    rating: 69,  weight: 57.0, odds: 2.70, good:{w:2,p:2,s:4}, soft:{w:1,p:0,s:1}, heavy:{w:0,p:0,s:0}, best_dist: 2000 },
    { no: 7, name: "Arabian Prince",   rating: 65,  weight: 57.0, odds: 5.50, good:{w:1,p:1,s:2}, soft:{w:1,p:0,s:2}, heavy:{w:0,p:0,s:0}, best_dist: 2000 },
    { no: 8, name: "Mcwoody",          rating: 63,  weight: 57.0, odds: 21.0, good:{w:1,p:1,s:2}, soft:{w:0,p:0,s:0}, heavy:{w:0,p:0,s:0}, best_dist: 1600 },
    { no: 9, name: "Deal Done Fast",   rating: 63,  weight: 57.0, odds: 9.00, good:{w:1,p:1,s:2}, soft:{w:0,p:0,s:0}, heavy:{w:0,p:0,s:0}, best_dist: 1800 },
    { no:10, name: "Fabulous Fiano",   rating: 58,  weight: 57.0, odds:81.00, good:{w:0,p:0,s:2}, soft:{w:0,p:0,s:0}, heavy:{w:0,p:0,s:0}, best_dist: 1700 },
  ]
};

/*
  ====================
  AI-Bet v3.7 Formula
  ====================
  Score = 100 * [
      0.40 * RatingFactor +
      0.20 * TrackFit      +
      0.20 * DistanceFit   +
      0.20 * WeightFactor
  ]

  - RatingFactor: rating / 80 (clamped 0..1)
  - TrackFit: win% on today’s surface vs overall (neutral 0.50 if missing)
  - DistanceFit: Gaussian around best_dist (neutral 0.50 if missing)
  - WeightFactor: exp(-0.035 * (wt - 56.5)) normalized to ~0.5..1.1 (clamped 0..1)
  Then softmax(scores) → model probabilities.
  Market probabilities are the normalized inverse odds.
  Edge = ModelProb − MarketProb.
*/

const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));
function pct(w,p,s){ // use (wins + 0.5*places) / starts as a workable surface proxy
  if(!s || s<=0) return null;
  return clamp((w + 0.5*p) / s, 0, 1);
}
function surfaceFit(h, track){
  let base = 0.5; // neutral
  let s = null;
  if(track.startsWith("Good") && h.good) s = pct(h.good.w, h.good.p, h.good.s);
  if(track.startsWith("Soft") && h.soft) s = pct(h.soft.w, h.soft.p, h.soft.s);
  if(track.startsWith("Heavy")&& h.heavy) s = pct(h.heavy.w, h.heavy.p, h.heavy.s);
  return s==null ? base : s; // already 0..1
}
function distanceFit(h, dist){
  if(!h.best_dist) return 0.5;
  const d = Math.abs(dist - h.best_dist);
  // 0m diff → 1.0, 400m diff → ~0.61, 800m diff → ~0.37
  return clamp(Math.exp(- (d*d) / (2 * 350*350)), 0, 1);
}
function weightFactor(h){
  if(!h.weight) return 0.5;
  const raw = Math.exp(-0.035 * (h.weight - 56.5)); // heavier → downweight
  // Normalize around 0.5..1.0 range
  return clamp((raw - 0.5) / 0.7, 0, 1);
}
function ratingFactor(h){
  if(!h.rating) return 0.5;
  return clamp(h.rating / 80, 0, 1);
}
function softmax(arr){
  const m = Math.max(...arr);
  const exps = arr.map(x=>Math.exp(x - m));
  const sum = exps.reduce((a,b)=>a+b,0);
  return exps.map(x=>x/sum);
}
function marketProbs(horses){
  // Implied = 1/odds; normalize so they sum to 1 (ignores overround here)
  const imps = horses.map(h => 1/Math.max(h.odds||999, 1e-9));
  const s = imps.reduce((a,b)=>a+b,0);
  return imps.map(x=>x/s);
}

function runModel(){
  // Meta
  document.getElementById("meta").innerHTML = `
    <div><span class="muted">Meeting</span><br><b>${RACE.meeting}</b></div>
    <div><span class="muted">Race</span><br><b>${RACE.race_name}</b></div>
    <div><span class="muted">Distance</span><br><b>${RACE.distance_m} m</b></div>
    <div><span class="muted">Track</span><br><b>${RACE.track_condition}</b></div>
    <div><span class="muted">Rail</span><br><b>${RACE.rail}</b></div>
    <div><span class="muted">Date/Time</span><br><b>${RACE.date}</b></div>
  `;

  // Compute model scores
  const scored = RACE.horses.map(h=>{
    const rf = ratingFactor(h);                  // 0..1
    const tf = surfaceFit(h, RACE.track_condition);
    const df = distanceFit(h, RACE.distance_m);
    const wf = weightFactor(h);

    const score = 100*(0.40*rf + 0.20*tf + 0.20*df + 0.20*wf); // 0..100
    return {...h, rf, tf, df, wf, score};
  });

  // Turn scores into model probabilities
  const modelPs = softmax(scored.map(x=>x.score));
  scored.forEach((h,i)=>h.modelP = modelPs[i]);

  // Market probs from odds
  const mktPs = marketProbs(scored);
  scored.forEach((h,i)=>h.mktP = mktPs[i]);
  scored.forEach(h=>h.edge = h.modelP - h.mktP);

  // Sort by model rank
  scored.sort((a,b)=> b.modelP - a.modelP);

  // Top 4 list
  const top4 = scored.slice(0,4)
  .map((h,i)=> `<li><span class="badge">${i+1}</span> &nbsp; #${h.no} ${h.name} <span class="small muted">(${(h.modelP*100).toFixed(1)}%)</span></li>`)
  .join("");
  document.getElementById("top4").innerHTML = top4;

  // Table
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = scored.map(h=>{
    const edgeClass = h.edge >= 0 ? "edge-good" : "edge-bad";
    return `
      <tr>
        <td>${h.no}</td>
        <td>${h.name}</td>
        <td>${h.odds ? h.odds.toFixed(2) : "-"}</td>
        <td>${h.rating ?? "-"}</td>
        <td>${h.weight ? h.weight.toFixed(1) : "-"}</td>
        <td><span class="pill">${(h.tf*100).toFixed(0)}%</span></td>
        <td><span class="pill">${(h.df*100).toFixed(0)}%</span></td>
        <td>${h.score.toFixed(1)}</td>
        <td>${(h.modelP*100).toFixed(1)}%</td>
        <td>${(h.mktP*100).toFixed(1)}%</td>
        <td class="${edgeClass}">${(h.edge*100).toFixed(1)}%</td>
      </tr>
    `;
  }).join("");
}

runModel();
</script>
</body>
</html>
